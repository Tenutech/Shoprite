<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Intervention\Image\Facades\Image;
use TCPDF;

class DocumentController extends Controller
{
    /**
     * Apply a signature to a PDF document.
     *
     * @param Request $request
     * @param int $documentId
     * @return \Illuminate\Http\JsonResponse
     */
    public function signDocument(Request $request, $documentId)
    {
        $request->validate([
            'signature' => 'required',
            'x' => 'required|numeric',
            'y' => 'required|numeric',
        ]);

        $document = Document::findOrFail($documentId);
        $pdfPath = storage_path('app/public/documents/' . $document->file_path);

        $signature = base64_decode(preg_replace('#^data:image/\w+;base64,#i', '', $request->input('signature')));

        $pdf = new TCPDF();
        $pdf->setPrintHeader(false);
        $pdf->setPrintFooter(false);
        $pdf->AddPage();

        $pdf->setSourceFile($pdfPath);
        $tplIdx = $pdf->importPage(1);
        $pdf->useTemplate($tplIdx, 0, 0, 210, 297);
        $signatureImagePath = storage_path('app/public/signatures/temp_signature.png');
        file_put_contents($signatureImagePath, $signature);

        $pdf->Image($signatureImagePath, $request->input('x'), $request->input('y'), 50, 30, 'PNG');

        $signedPdfPath = storage_path('app/public/documents/signed_' . $document->file_path);

        $pdf->Output($signedPdfPath, 'F');

        $document->status = 'signed';
        $document->signed_file_path = 'signed_' . $document->file_path;
        $document->save();

        unlink($signatureImagePath);

        return response()->json(['message' => 'Document signed successfully!'], 200);
    }
}